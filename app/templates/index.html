{% extends "container.html" %}

{% block js %}
<script type="text/javascript" src="{{ url_for('.static', filename='js/typeahead.js')}}"></script>
<script type="text/javascript">
    $(document).ready(function() {
        /********************************************************************
         *  Autocomplete for the author
         */
        var author_autocomplete = new Bloodhound({
          "datumTokenizer": function (datum) {
            return Bloodhound.tokenizers.whitespace(
                datum.title + " " + datum.author
            );
          },
          queryTokenizer: Bloodhound.tokenizers.whitespace,
          identify : function(datum) { return datum.id; },
          prefetch: {
            url: "{{ url_for(".authors") }}"
          }
        });

        $('#text-typeahead').typeahead(null, {
          name: 'text-id',
          source: author_autocomplete,
          limit: 15,
          display: function(datum) { return datum.title + " - " + datum.author; }
        }).bind('typeahead:select', function(ev, suggestion) {
          $("#text-id").val(suggestion.id);
        });;


        /********************************************************************
         *
         * Build identifiers from text identifier and passage identifier
         */
        $("#build-id").on("click", function(e) {
            e.preventDefault();
            $("#source-id").val(
                $("#text-id").val() + ":" + $("#passage-id").val()
            );
        });

        /********************************************************************
         *  Retrieves the text based on the source identifier
         */

        $("#retrieve-id").on("click", function(e) {
            e.preventDefault();
            var parts  = $("#source-id").val().split(":"),
                textId = parts.slice(0, parts.length-1).join(":"),
                psgId  = parts[parts.length-1];
            $.ajax(
                "{{ url_for(".passage") }}?id="+textId+"&passage="+psgId
            ).done(function(data) {
                $("#plain-text").val(data.text);
            });
        });

        /********************************************************************
         *  Retrieves the text based on the source identifier
         */

        $("#transform").on("click", function(e) {
            e.preventDefault();
            $.ajax({
                url: "{{ url_for(".lemmatize") }}",
                type: "POST",
                data: $("#main-form").serialize()
            }).done(function(data) {
                $("#xml").val(new XMLSerializer().serializeToString(data));
            });
        });

        /********************************************************************
         *  Save
         */

        $("#save").on("click", function(e) {
            e.preventDefault();
            $.ajax({
                url: "{{ url_for(".save") }}",
                type: "POST",
                data: $("#main-form").serialize()
            }).done(function(data) {
                alert("Saved at " + data.path);
            });
        });
    });
</script>
{% endblock %}

{% block body %}
    <form class="form" method="POST" action="{{ url_for(".save") }}" id="main-form">
      <div class="form-group row">
        <label for="pb" class="col-sm-4 col-form-label">Page Beginning (Leave empty if not needed)</label>
        <div class="col-sm-8">
          <input type="number" class="form-control" id="pb" placeholder="Page Beginning" name="pb">
        </div>
      </div>
      <div class="form-group row">
        <label for="category" class="col-sm-4 col-form-label">Category</label>
        <div class="col-sm-8">
          <input type="text" class="form-control" id="category" placeholder="Category" name="category">
        </div>
      </div>
      <div class="form-group row">
        <label for="text-typeahead" class="col-sm-4 col-form-label">Text Identifier</label>
        <div class="col-sm-8">
          <input type="text" class="form-control" id="text-typeahead" placeholder="Text identifier" name="text-typeahead">
        </div>
      </div>
      <div class="form-group row">
        <div class="col-sm-8 offset-sm-4">
          <input type="text" class="form-control" id="text-id" disabled name="text-id">
        </div>
      </div>
      <div class="form-group row">
        <label for="passage-id" class="col-sm-4 col-form-label">Passage Identifier</label>
        <div class="col-sm-8">
          <input type="text" class="form-control" id="passage-id" placeholder="Passage identifier" name="passage-id">
        </div>
      </div>
      <div class="form-group row">
        <label for="source-id" class="col-sm-4 col-form-label">Source Identifier</label>
        <div class="col-sm-8">
          <input type="text" class="form-control" id="source-id" placeholder="Source identifier" name="source-id">
        </div>
      </div>
      <div class="form-group row">
        <div class="col-sm-12 text-right">
            <button class="btn btn-outline-success" id="build-id">Build Identifier</button>
            <button class="btn btn-success" id="retrieve-id">Retrieve</button>
        </div>
      </div>
      <div class="form-group row">
        <label for="plain-text" class="col-sm-4 col-form-label">Plain Text</label>
        <div class="col-sm-8">
          <textarea class="form-control" id="plain-text"
                    placeholder="Text identifier" name="plain-text" rows="5"></textarea>
        </div>
      </div>
      <div class="form-group row">
        <div class="col-sm-12 text-right">
            <button class="btn btn-success" id="transform">Transform</button>
        </div>
      </div>
      <div class="form-group row">
        <label for="xml" class="col-sm-4 col-form-label">XML</label>
        <div class="col-sm-8">
          <textarea class="form-control" id="xml"
                    placeholder="Text identifier" name="xml" rows="2"></textarea>
        </div>
      </div>
      <div class="form-group row">
        <div class="col-sm-12 text-right">
            <button class="btn btn-primary" id="save">Save</button>
        </div>
      </div>
    </form>
{% endblock %}